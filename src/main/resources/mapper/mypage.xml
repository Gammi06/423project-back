<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="site.metacoding.miniproject1.domain.applicationStatus.ApplicationStatusDao">

	<select id="findUser"
		resultType="site.metacoding.miniproject1.web.dto.response.UserInfoDto">
		SELECT id, user_id, user_password,
		user_name, age,
		phone_number, email, photo,
		position_code_name, company_id,
		mycareer_id, created
		FROM users
		WHERE id=1;
	</select>

	<select id="findCompany"
		resultType="site.metacoding.miniproject1.web.dto.response.CompanyInfoDto">
		SELECT @ROWNUM :=@ROWNUM+1 AS no, comrec.*
		FROM (SELECT com.id, com.company_name, com.address, com.email,
		com.company_number, com.photo,
		com.region_code_name, com.intro,
		com.years, com.member_count, com.created,
		wan.id wanted_id,
		wan.position_code_id, wan.career_code_id, wan.pay,
		wan.title,
		wan.detail, wan.view_count, wan.enddate, wan.checked
		FROM companys com
		INNER JOIN wanteds wan
		ON com.id = wan.company_id
		INNER JOIN resumes res
		ON wan.position_code_id = res.positions_code_id
		WHERE res.user_id = 1
		ORDER BY RAND() LIMIT 4) comrec,
		(SELECT @ROWNUM := 0) R
	</select>

	<select id="findInfoCounts"
	resultType="site.metacoding.miniproject1.web.dto.response.InfoCountDto">
		SELECT count((IFNULL(state, 0))) AS statusAll,
		(SELECT count((IFNULL(wanted_id, 0))) AS likesCount
		FROM likes
		WHERE user_id = 1) likesCount,
		(SELECT count((IFNULL(company_id, 0))) AS subscribesCount
		FROM subscribes
		WHERE user_id = 1) subscribesCount,
		(SELECT count((IFNULL(wanted_id, 0))) AS requestsCount
		FROM requests
		WHERE resume_id = 1) requestsCount
		FROM application_status
	</select>


	<select id="findAll"
		resultType="site.metacoding.miniproject1.web.dto.response.StatusInfoDto">
		SELECT apps.id id, apps.wanted_id wantedId,
		apps.resume_id resumeId,
		apps.state state,
		apps.created created, wan.position_code_id
		positionCodeId,
		wan.company_id companyId, com.company_name
		companyName,
		poco.name positionCodeName
		FROM application_status apps
		INNER JOIN wanteds wan
		ON apps.wanted_id = wan.id
		INNER JOIN companys com
		ON wan.company_id = com.id
		INNER JOIN positions_code poco
		ON wan.position_code_id = poco.id
		<if test="keyword != null">
			WHERE com.company_name LIKE CONCAT('%',#{keyword},'%')
		</if>
		ORDER BY apps.id DESC
	</select>

	<select id="findCounts"
		resultType="site.metacoding.miniproject1.web.dto.response.StatusCountDto">
		SELECT count((IFNULL(state, 0))) AS statusAll,
		(SELECT
		count((IFNULL(state, 0))) AS statusC
		FROM application_status
		WHERE state
		= 0) statusC,
		(SELECT count((IFNULL(state, 0))) AS statusFinal
		FROM
		application_status
		WHERE state = 1) statusFinal
		FROM application_status
	</select>

	<select id="findWaiting"
		resultType="site.metacoding.miniproject1.web.dto.response.StatusWaitingInfoDto">
		SELECT apps.id id, apps.wanted_id wantedId,
		apps.resume_id resumeId,
		apps.state state,
		apps.created created, wan.position_code_id
		positionCodeId,
		wan.company_id companyId, com.company_name
		companyName,
		poco.name positionCodeName
		FROM application_status apps
		INNER JOIN wanteds wan
		ON
		apps.wanted_id = wan.id
		INNER JOIN companys com
		ON wan.company_id =
		com.id
		INNER JOIN positions_code poco
		ON wan.position_code_id = poco.id
		WHERE apps.state = 0
		<if test="keyword != null">
			AND com.company_name LIKE CONCAT('%',#{keyword},'%')
		</if>
		ORDER BY apps.id DESC
	</select>

	<select id="findFinal"
		resultType="site.metacoding.miniproject1.web.dto.response.StatusFinalInfoDto">
		SELECT apps.id id, apps.wanted_id wantedId,
		apps.resume_id resumeId,
		apps.state state,
		apps.created created, wan.position_code_id
		positionCodeId,
		wan.company_id companyId, com.company_name
		companyName,
		poco.name positionCodeName
		FROM application_status apps
		INNER JOIN wanteds wan
		ON
		apps.wanted_id = wan.id
		INNER JOIN companys com
		ON wan.company_id =
		com.id
		INNER JOIN positions_code poco
		ON wan.position_code_id = poco.id
		WHERE apps.state = 1
		<if test="keyword != null">
			AND com.company_name LIKE CONCAT('%',#{keyword},'%')
		</if>
		ORDER BY apps.id DESC
	</select>

	<select id="findRequest"
		resultType="site.metacoding.miniproject1.web.dto.response.RequestsInfoDto">
		SELECT req.id, req.resume_id, req.wanted_id, req.status, req.created,
		wan.position_code_id, wan.career_code_id, wan.company_id,
		com.company_name,
		poco.name positionCodeName
		FROM requests req
		INNER JOIN wanteds wan
		ON req.wanted_id = wan.id
		INNER JOIN companys com
		ON wan.company_id=com.id
		INNER JOIN positions_code poco
		ON wan.position_code_id = poco.id
		<if test="keyword != null">
			WHERE com.company_name LIKE CONCAT('%',#{keyword},'%')
		</if>
		ORDER BY req.id DESC
	</select>



</mapper>